#!/usr/bin/env sh
# Tiny wrapper to execute the Rust-based launcher.
# It prefers an existing compiled binary (release or debug),
# otherwise attempts to build with cargo and run it.
set -e

# Ensure common PATHs for rustup and Homebrew on macOS
export PATH="$HOME/.cargo/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"

# Initialize macOS default PATH with path_helper if available
if [ -x /usr/libexec/path_helper ]; then
  eval "$(/usr/libexec/path_helper -s)"
fi

# Initialize Homebrew environment (helps when non-interactive shells miss brew paths)
if [ -x /opt/homebrew/bin/brew ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif command -v brew >/dev/null 2>&1; then
  eval "$(brew shellenv)"
fi

# Source rustup environment if available (ensures cargo in PATH)
if [ -f "$HOME/.cargo/env" ]; then
  # shellcheck source=/dev/null
  . "$HOME/.cargo/env"
fi

BIN="${AIFO_CODER_BIN:-./target/release/aifo-coder}"

if [ ! -x "$BIN" ] && [ -x "./target/debug/aifo-coder" ]; then
  BIN="./target/debug/aifo-coder"
fi

# Helper: check if a binary is runnable on this host (avoids Exec format error)
can_run() {
  "$1" --version >/dev/null 2>&1
}

# If cargo is available, rebuild if sources are newer than the current binary
if command -v cargo >/dev/null 2>&1; then
  NEED_BUILD=0
  if [ ! -x "$BIN" ]; then
    NEED_BUILD=1
  elif [ -f Cargo.toml ] && [ Cargo.toml -nt "$BIN" ]; then
    NEED_BUILD=1
  elif [ -d src ] && find src -type f -newer "$BIN" -print -quit | grep -q .; then
    NEED_BUILD=1
  fi
  if [ "$NEED_BUILD" -eq 1 ]; then
    echo "Building aifo-coder (release)..." >&2
    cargo build --release
    BIN="./target/release/aifo-coder"
  fi
fi

if [ -x "$BIN" ] && can_run "$BIN"; then
  exec "$BIN" "$@"
fi

if command -v cargo >/dev/null 2>&1; then
  echo "Building aifo-coder (release)..." >&2
  cargo build --release
  BIN="./target/release/aifo-coder"
  if [ -x "$BIN" ] && can_run "$BIN"; then
    exec "$BIN" "$@"
  fi
fi

# Try to build inside a container using Docker
if command -v docker >/dev/null 2>&1; then
  echo "Building aifo-coder (release) using docker and rust:1-bookworm ..." >&2
  docker run --rm -u "$(id -u):$(id -g)" \
    -v "$PWD:/workspace" \
    -v "$HOME/.cargo/registry:/root/.cargo/registry" \
    -v "$HOME/.cargo/git:/root/.cargo/git" \
    -v "$PWD/target:/workspace/target" \
    -w /workspace rust:1-bookworm cargo build --release
  BIN="./target/release/aifo-coder"
  if [ -x "$BIN" ] && can_run "$BIN"; then
    exec "$BIN" "$@"
  else
    echo "Error: built binary at $BIN is not executable on this host (architecture mismatch?)." >&2
    echo "Try: rm -rf ./target && re-run this script, or install Rust (https://rustup.rs) to build natively." >&2
  fi
fi

echo "Error: compiled launcher not found and neither cargo nor Docker is installed." >&2
echo "Please install Rust (https://rustup.rs), or install Docker so the wrapper can build inside a container." >&2
exit 127
