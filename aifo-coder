#!/usr/bin/env sh
# Tiny wrapper to execute the Rust-based launcher.
# It prefers an existing compiled binary (release or debug),
# otherwise attempts to build with cargo and run it.
# 
# Environment overrides:
# - AIFO_CODER_PROJECT_ROOT: override project root detection
# - AIFO_CODER_BIN: direct path to a compiled aifo-coder binary
# - RUST_BUILDER_IMAGE: Docker image tag used for container builds (fallback)
#
# Behavior overview:
# - Prefers an installed and runnable aifo-coder on PATH (not this script)
# - Rebuilds with cargo when sources are newer than the current binary
# - Falls back to Docker build if cargo is unavailable
# - Supports cross-compile on Windows/MSYS by setting target and release folder
set -e

# Determine executable suffix on Windows environments (Git Bash/MSYS/Cygwin)
EXE=""
case "$(uname -s 2>/dev/null || echo unknown)" in
  MINGW*|MSYS*|CYGWIN*|Windows_NT) EXE=".exe" ;;
esac

# Default compile-time flags (kept in sync with Makefile CARGO_FLAGS).
: "${CARGO_FLAGS:=--features otel-otlp}"

# Ensure common PATHs for rustup and Homebrew on macOS
export PATH="$HOME/.cargo/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"

# Initialize macOS default PATH with path_helper if available
if [ -x /usr/libexec/path_helper ]; then
  eval "$(/usr/libexec/path_helper -s)"
fi

# Initialize Homebrew environment (helps when non-interactive shells miss brew paths)
if [ -x /opt/homebrew/bin/brew ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif command -v brew >/dev/null 2>&1; then
  eval "$(brew shellenv)"
fi

# Source rustup environment if available (ensures cargo in PATH)
if [ -f "$HOME/.cargo/env" ]; then
  # shellcheck source=/dev/null
  . "$HOME/.cargo/env"
fi

# Determine project root based on script location (follow symlinks if possible)
SCRIPT_INVOCATION="$(command -v -- "$0" 2>/dev/null || echo "$0")"
if command -v readlink >/dev/null 2>&1; then
  TARGET="$SCRIPT_INVOCATION"
  while [ -L "$TARGET" ]; do
    DIR="$(cd -P "$(dirname "$TARGET")" && pwd)"
    LINK="$(readlink "$TARGET")"
    case "$LINK" in
      /*) TARGET="$LINK" ;;
      *) TARGET="$DIR/$LINK" ;;
    esac
  done
  SCRIPT_PATH="$TARGET"
else
  SCRIPT_PATH="$SCRIPT_INVOCATION"
fi
PROJECT_ROOT_DEFAULT="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
PROJECT_ROOT="${AIFO_CODER_PROJECT_ROOT:-$PROJECT_ROOT_DEFAULT}"
# Ensure build.rs can bake the default OTLP endpoint from local file
export AIFO_OTEL_ENDPOINT_FILE="$PROJECT_ROOT/otel-otlp.url"

BIN="${AIFO_CODER_BIN:-$PROJECT_ROOT/target/release/aifo-coder$EXE}"

if [ ! -x "$BIN" ] && [ -x "$PROJECT_ROOT/target/debug/aifo-coder$EXE" ]; then
  BIN="$PROJECT_ROOT/target/debug/aifo-coder$EXE"
fi

# Helper: check if a binary is runnable on this host (avoids Exec format error)
can_run() {
  "$1" --version >/dev/null 2>&1
}

# If an installed system binary exists (not this script), prefer it
SYS_BIN="$(command -v aifo-coder 2>/dev/null || true)"
THIS_BIN="$(command -v -- "$0" 2>/dev/null || echo "$0")"
if [ -n "$SYS_BIN" ] && [ "$SYS_BIN" != "$THIS_BIN" ] && can_run "$SYS_BIN"; then
  exec "$SYS_BIN" "$@"
fi

# If cargo is available, rebuild if sources are newer than the current binary
if command -v cargo >/dev/null 2>&1; then
  NEED_BUILD=0
  if [ ! -x "$BIN" ]; then
    NEED_BUILD=1
  elif [ -f "$PROJECT_ROOT/Cargo.toml" ] && [ "$PROJECT_ROOT/Cargo.toml" -nt "$BIN" ]; then
    NEED_BUILD=1
  elif [ -f "$PROJECT_ROOT/build.rs" ] && [ "$PROJECT_ROOT/build.rs" -nt "$BIN" ]; then
    NEED_BUILD=1
  elif [ -d "$PROJECT_ROOT/src" ] && find "$PROJECT_ROOT/src" -type f -newer "$BIN" -print -quit | grep -q .; then
    NEED_BUILD=1
  elif [ -d "$PROJECT_ROOT/tests" ] && find "$PROJECT_ROOT/tests" -type f -newer "$BIN" -print -quit | grep -q .; then
    NEED_BUILD=1
  fi
  if [ "$NEED_BUILD" -eq 1 ]; then
    echo "Building aifo-coder (release)..."
    CARGO_TARGET_DIR="$PROJECT_ROOT/target" cargo build $CARGO_FLAGS --release --manifest-path "$PROJECT_ROOT/Cargo.toml"
    BIN="$PROJECT_ROOT/target/release/aifo-coder$EXE"
  fi
fi

if [ -x "$BIN" ] && can_run "$BIN"; then
  for arg in "$@"; do
    if [ "$arg" = "--debug-otel-otlp" ]; then
      export AIFO_CODER_OTEL_DEBUG_OTLP=1
      break
    fi
  done
  exec "$BIN" "$@"
fi

if command -v cargo >/dev/null 2>&1; then
  echo "Building aifo-coder (release)..."
  CARGO_TARGET_DIR="$PROJECT_ROOT/target" cargo build $CARGO_FLAGS --release --manifest-path "$PROJECT_ROOT/Cargo.toml"
  BIN="$PROJECT_ROOT/target/release/aifo-coder$EXE"
  if [ -x "$BIN" ] && can_run "$BIN"; then
    for arg in "$@"; do
      if [ "$arg" = "--debug-otel-otlp" ]; then
        export AIFO_CODER_OTEL_DEBUG_OTLP=1
        break
      fi
    done
    exec "$BIN" "$@"
  fi
fi

# Try to build inside a container using Docker
if command -v docker >/dev/null 2>&1; then
  echo "Building aifo-coder (release) using docker and rust:1-bookworm ..."
  PLAT=""
  arch="$(uname -m 2>/dev/null || echo unknown)"
  case "$arch" in
    x86_64|amd64) PLAT="linux/amd64" ;;
    aarch64|arm64) PLAT="linux/arm64" ;;
    *) PLAT="" ;;
  esac
  echo "Detected architecture: $PLAT"
  # Detect if host is windows
  kernel="$(uname -s 2>/dev/null || echo unknown)"
  case "$kernel" in
    MINGW*|MSYS*|CYGWIN*|Windows_NT)
      echo "Detected windows kernel. Configuring for cross compilation"
      RELEASE_FOLDER="x86_64-pc-windows-gnu/"
      CARGO_TARGET="--target x86_64-pc-windows-gnu" ;;
    *)
      RELEASE_FOLDER=""
      CARGO_TARGET="" ;;  # No cross compile required
  esac
  if [ -n "$PLAT" ]; then DOCKER_PLATFORM_ARGS="--platform $PLAT"; else DOCKER_PLATFORM_ARGS=""; fi
  MSYS_NO_PATHCONV=1 \
    docker run $DOCKER_PLATFORM_ARGS --rm -e AIFO_OTEL_ENDPOINT_FILE=/workspace/otel-otlp.url \
      -v "$PROJECT_ROOT:/workspace" \
      -v "$HOME/.cargo/registry:/root/.cargo/registry" \
      -v "$HOME/.cargo/git:/root/.cargo/git" \
      -v "$PROJECT_ROOT/target:/workspace/target" \
      -w /workspace \
      "${RUST_BUILDER_IMAGE:-aifo-coder-rust-builder}" cargo build --release $CARGO_TARGET
  BIN="$PROJECT_ROOT/target/${RELEASE_FOLDER}release/aifo-coder$EXE"
  if [ -x "$BIN" ] && can_run "$BIN"; then
    for arg in "$@"; do
      if [ "$arg" = "--debug-otel-otlp" ]; then
        export AIFO_CODER_OTEL_DEBUG_OTLP=1
        break
      fi
    done
    exec "$BIN" "$@"
  else
    echo "Error: built binary at $BIN is not executable on this host (architecture mismatch?)." >&2
    echo "Try: rm -rf ./target && re-run this script, or install Rust (https://rustup.rs) to build natively." >&2
  fi
fi

echo "Error: compiled launcher not found and neither cargo nor Docker is installed." >&2
echo "Please install Rust (https://rustup.rs), or install Docker so the wrapper can build inside a container." >&2
exit 127
