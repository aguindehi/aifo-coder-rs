stages:
  - build
  - test
  - release

include:
  - component: $CI_SERVER_FQDN/devops-services-public/infrastructure-as-code/cicd-components/container/build@0.14.0
    inputs:
      image_tag_custom: $CI_COMMIT_SHA

variables:
  PACKAGE_REGISTRY_URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${CI_COMMIT_TAG}

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Rules
.rules_build_image: &rules_build_image
  - if: $CI_COMMIT_TAG

# Base job provided as cicd-component by the cloud team. Used as template and should not run on its own
container-build:
  variables:
    #TARGET: Has to be provided by a child job. Defines the name of the target container within the Dockerfile.
    KANIKO_CACHE_ARGS: "--cache=true --cache-ttl=168h --cache-repo $CI_REGISTRY_IMAGE/kaniko-cache"
    IMAGE_PREFIX: "coder"
    IMAGE_TAG_CUSTOM: $CI_COMMIT_TAG
    IMAGE_TAG_CUSTOM_ONLY: true
  before_script:
    - |
      IMAGE_PATH_EXTRA="aifo-${IMAGE_PREFIX}-${IMAGE_PATH_EXTRA:-$TARGET}"
      KANIKO_BUILD_OPTIONS=""
      # If TARGET_NAME or TARGET is provided, add --target attribute to build
      [ -n "${TARGET_NAME:-$TARGET}" ] && KANIKO_BUILD_OPTIONS="--target ${TARGET_NAME:-$TARGET}"
  rules: # Turn off component rules
    - if: $CI_COMMIT_BRANCH == "never"
      when: never


# Build images

build-rust-builder:
  extends: container-build
  stage: build
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
  timeout: 45m
  variables:
    TARGET_NAME: "rust-builder"
    IMAGE_PATH_EXTRA: "rust-builder"
  # Consolidated rules: tags -> :$CI_COMMIT_TAG, default-branch changes -> :ci, branches/MRs -> per-commit <$CI_COMMIT_REF_SLUG>:$CI_COMMIT_SHA
  rules:
    # Release tags: publish builder as :$CI_COMMIT_TAG
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_TAG
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Merge requests: publish per-commit builder under <slug>:$CI_COMMIT_SHA
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_SHA
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Default branch: rebuild stable 'ci' tag only when relevant build inputs change
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - Dockerfile
        - Cargo.toml
        - Cargo.lock
        - build.rs
        - .cargo/**/*
        - rust-toolchain.toml
        - src/**/*
        - toolchains/**/*
        - .gitlab-ci.yml
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Manual refresh of the 'ci' tag on default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: true
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Other branches: publish per-commit builder under <slug>:$CI_COMMIT_SHA
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_SHA
        IMAGE_TAG_CUSTOM_ONLY: "true"



build:
  extends: container-build
  stage: build
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  rules: *rules_build_image
  parallel:
    matrix:
      - TARGET: [ "codex","crush","aider","openhands","opencode","plandex",
                  "codex-slim","crush-slim","aider-slim","openhands-slim","opencode-slim","plandex-slim" ]

build-toolchain:
  extends: container-build
  stage: build
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  variables:
    IMAGE_PATH_EXTRA: "$FOLDER"
    IMAGE_PREFIX: "toolchain"
    DOCKER_FILE: "toolchains/$FOLDER/Dockerfile"
  rules: *rules_build_image
  parallel:
    matrix:
      - FOLDER: [ "rust", "node", "cpp" ]


# Build executables

build-launcher:
  stage: build
  needs:
    - job: build-rust-builder
  image: $CI_REGISTRY_IMAGE/aifo-coder-rust-builder:$CI_COMMIT_TAG
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  script:
    - cargo --version
    - rustc --version
    - echo "Building launcher (Linux native) ..."
    - cargo build --release
    - cp target/release/aifo-coder ./aifo-coder  # Copy to root folder to not have folder structure in GitLab artifacts
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  rules:
    - if: $CI_COMMIT_TAG


check:
  stage: test
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
  timeout: 30m
  image: $RB_IMAGE
  # Use optional needs so default-branch 'ci' builder can be change-skipped while check still runs.
  needs:
    - job: build-rust-builder
      optional: true
  tags:
    - qual-mcap-gcp
  variables:
    RUST_BACKTRACE: "1"
    AIFO_SUPPORT_ANIMATE: "0"
    CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
    JUNIT_OUT: "build/junit.xml"
    ARGS_NEXTEST: '--no-fail-fast --status-level=fail --hide-progress-bar --cargo-quiet -E "!test(/^test_http_/) & !test(/^test_proxy_/)" --junit-report=$(JUNIT_OUT)'
    GIT_LFS_SKIP_SMUDGE: "1"
  cache:
    key: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}"
    policy: pull-push
    paths:
      - .cargo
      - target
  artifacts:
    when: always
    expire_in: 1 week
    reports:
      junit: build/junit.xml
    paths:
      - build/junit.xml
  before_script:
    - rustc --version
    - cargo --version
    # Ensure rustfmt/clippy are present in this container (CI only)
    - if command -v rustup >/dev/null 2>&1; then rustup component add --toolchain stable rustfmt clippy >/dev/null 2>&1 || true; fi
    # git-lfs is preinstalled in rust-builder image; no apt-get here
    - cargo nextest --version || true
    # Probe clippy via rustup after installing components to avoid false errors
    - if command -v rustup >/dev/null 2>&1; then rustup run stable cargo clippy --version || true; else cargo clippy --version || true; fi
  script:
    - make check
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    # Merge requests: use per-commit builder image
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
    # Non-default branches: use per-commit builder image
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
    # Default branch: use stable 'ci' tag
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder:ci"

# Create release

publish-release:
  stage: release
  needs:
    - job: build-launcher
      artifacts: true
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  image: repository.migros.net/registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Running the release job."
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "$CI_COMMIT_MESSAGE"
    assets:
      links:
        - name: aifo-coder
          url: $CI_JOB_URL/artifacts/download
  rules:
    - if: $CI_COMMIT_TAG
