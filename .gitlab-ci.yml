stages:
  - build
  - publish

include:
  - component: $CI_SERVER_FQDN/devops-services-public/infrastructure-as-code/cicd-components/container/build@0.14.0
    inputs:
      image_tag_custom: $CI_COMMIT_SHA


# Rules
.rules_build_image: &rules_build_image
  - if: $CI_COMMIT_BRANCH == "main"
  - if: $CI_COMMIT_BRANCH == "feat/AIFO-1530-add-pipelines"  # TODO Remove test

.rules_build_executable: &rules_build_executable
  - if: $CI_COMMIT_BRANCH == "main"
  - if: $CI_COMMIT_BRANCH == "feat/AIFO-1530-add-pipelines"  # TODO Remove test

# Base job provided as cicd-component by the cloud team. Used as template and should not run on its own
container-build:
  variables:
    #TARGET: Has to be provided by a child job. Defines the name of the target container within the Dockerfile.
    KANIKO_CACHE_ARGS: "--cache=true --cache-ttl=168h --cache-repo $CI_REGISTRY_IMAGE/kaniko-cache"
  before_script:
    - |
      IMAGE_PATH_EXTRA="${TARGET_NAME:-$TARGET}"
      KANIKO_BUILD_OPTIONS="--target ${TARGET_NAME:-$TARGET}"
  rules: # Turn off component rules
    - if: $CI_COMMIT_BRANCH == "never"
      when: never


# Build images

build-rust-builder:
  extends: container-build
  stage: build
  variables:
    TARGET_NAME: "rust-builder"
  rules: *rules_build_image

build:
  extends: container-build
  stage: build
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  rules: *rules_build_image
  parallel:
    matrix:
      - TARGET: [ "codex","crush","aider","openhands","opencode","plandex",
                  "codex-slim","crush-slim","aider-slim","openhands-slim","opencode-slim","plandex-slim" ]

build-toolchain:
  extends: container-build
  stage: build
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  variables:
    TARGET_NAME: "toolchain-$FOLDER"
    DOCKER_FILE: "toolchains/$FOLDER/Dockerfile"
  rules: *rules_build_image
  parallel:
    matrix:
      - FOLDER: [ "rust", "node", "cpp" ]


# Build executables

build-launcher:
  stage: build
  needs:
    - job: build-rust-builder
  image: $CI_REGISTRY_IMAGE/rust-builder:$CI_COMMIT_SHA
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  script:
    - cargo --version
    - rustc --version
    - echo "Building launcher (Linux native) ..."
    - cargo build --release
    - cp target/release/aifo-coder ./aifo-coder  # Copy to root folder to not have folder structure in GitLab artifacts
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  rules: *rules_build_executable
