stages:
  - test
  - build
  - release

include:
  - component: $CI_SERVER_FQDN/devops-services-public/infrastructure-as-code/cicd-components/container/build@0.14.0
    inputs:
      image_tag_custom: $CI_COMMIT_SHA

variables:
  PACKAGE_REGISTRY_URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${CI_COMMIT_TAG}

# Rules
.rules_build_image: &rules_build_image
  - if: $CI_COMMIT_TAG

# Base job provided as cicd-component by the cloud team. Used as template and should not run on its own
container-build:
  variables:
    #TARGET: Has to be provided by a child job. Defines the name of the target container within the Dockerfile.
    KANIKO_CACHE_ARGS: "--cache=true --cache-ttl=168h --cache-repo $CI_REGISTRY_IMAGE/kaniko-cache"
    IMAGE_PREFIX: "coder"
    IMAGE_TAG_CUSTOM: $CI_COMMIT_TAG
    IMAGE_TAG_CUSTOM_ONLY: true
  before_script:
    - |
      IMAGE_PATH_EXTRA="aifo-${IMAGE_PREFIX}-${IMAGE_PATH_EXTRA:-$TARGET}"
      KANIKO_BUILD_OPTIONS=""
      # If TARGET_NAME or TARGET is provided, add --target attribute to build
      [ -n "${TARGET_NAME:-$TARGET}" ] && KANIKO_BUILD_OPTIONS="--target ${TARGET_NAME:-$TARGET}"
  rules: # Turn off component rules
    - if: $CI_COMMIT_BRANCH == "never"
      when: never


# Build images

build-rust-builder:
  extends: container-build
  stage: build
  variables:
    TARGET_NAME: "rust-builder"
    IMAGE_PATH_EXTRA: "rust-builder"
  rules: *rules_build_image

build-rust-builder-ci:
  extends: container-build
  stage: build
  variables:
    TARGET_NAME: "rust-builder"
    IMAGE_PATH_EXTRA: "rust-builder"
    IMAGE_TAG_CUSTOM: "ci"
    IMAGE_TAG_CUSTOM_ONLY: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - Dockerfile
        - src/**/*
        - toolchains/**/*
        - .gitlab-ci.yml
    - when: manual
      allow_failure: true

build-rust-builder-checkimg:
  extends: container-build
  stage: test
  variables:
    TARGET_NAME: "rust-builder"
    IMAGE_PATH_EXTRA: "rust-builder"
    IMAGE_TAG_CUSTOM: $CI_COMMIT_SHA
    IMAGE_TAG_CUSTOM_ONLY: true
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:
  extends: container-build
  stage: build
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  rules: *rules_build_image
  parallel:
    matrix:
      - TARGET: [ "codex","crush","aider","openhands","opencode","plandex",
                  "codex-slim","crush-slim","aider-slim","openhands-slim","opencode-slim","plandex-slim" ]

build-toolchain:
  extends: container-build
  stage: build
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  variables:
    IMAGE_PATH_EXTRA: "$FOLDER"
    IMAGE_PREFIX: "toolchain"
    DOCKER_FILE: "toolchains/$FOLDER/Dockerfile"
  rules: *rules_build_image
  parallel:
    matrix:
      - FOLDER: [ "rust", "node", "cpp" ]


# Build executables

build-launcher:
  stage: build
  needs:
    - job: build-rust-builder
  image: $CI_REGISTRY_IMAGE/aifo-coder-rust-builder:$CI_COMMIT_TAG
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  script:
    - cargo --version
    - rustc --version
    - echo "Building launcher (Linux native) ..."
    - cargo build --release
    - cp target/release/aifo-coder ./aifo-coder  # Copy to root folder to not have folder structure in GitLab artifacts
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  rules:
    - if: $CI_COMMIT_TAG


check:
  stage: test
  image: $CI_REGISTRY_IMAGE/aifo-coder-rust-builder:$CI_COMMIT_SHA
  needs:
    - build-rust-builder-checkimg
  tags:
    - qual-mcap-gcp
  variables:
    RUST_BACKTRACE: "1"
    NO_COLOR: "1"
    AIFO_SUPPORT_ANIMATE: "0"
    CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  cache:
    key: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .cargo
      - target
  before_script:
    - rustc --version
    - cargo --version
    - cargo nextest --version || true
    - cargo clippy --version || true
  script:
    - make check
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Create release

publish-release:
  stage: release
  needs:
    - job: build-launcher
      artifacts: true
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  image: repository.migros.net/registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Running the release job."
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "$CI_COMMIT_MESSAGE"
    assets:
      links:
        - name: aifo-coder
          url: $CI_JOB_URL/artifacts/download
  rules:
    - if: $CI_COMMIT_TAG
