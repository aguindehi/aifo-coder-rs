stages:
  - pre
  - build
  - test
  - release

include:
  - component: $CI_SERVER_FQDN/devops-services-public/infrastructure-as-code/cicd-components/container/build@0.14.0
    inputs:
      image_tag_custom: $CI_COMMIT_SHA

variables:
  PACKAGE_REGISTRY_URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${CI_COMMIT_TAG}

# Workflow

workflow:
  rules:
    # Allow scheduled pipelines (e.g., nightly builder refresh)
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always

    # Prefer merge request pipelines for branches with MRs
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always

    # Suppress branch-push pipelines when an MR exists for the branch
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never

    # Allow normal branch pushes when no MR exists
    - if: $CI_PIPELINE_SOURCE == "push"
      when: always

    # Always allow tag pipelines
    - if: $CI_COMMIT_TAG
      when: always

# Rules

.rules_build_image: &rules_build_image
  - if: $CI_COMMIT_TAG

# Base job provided as cicd-component by the cloud team. Used as template and should not run on its own
container-build:
  variables:
    #TARGET: Has to be provided by a child job. Defines the name of the target container within the Dockerfile.
    KANIKO_CACHE_ARGS: "--cache=true --cache-ttl=168h --cache-repo $CI_REGISTRY_IMAGE/kaniko-cache"
    IMAGE_PREFIX: "coder"
    IMAGE_TAG_CUSTOM: $CI_COMMIT_TAG
    IMAGE_TAG_CUSTOM_ONLY: true
  before_script:
    - |
      IMAGE_PATH_EXTRA="aifo-${IMAGE_PREFIX}-${IMAGE_PATH_EXTRA:-$TARGET}"
      # Use time-based snapshotting to reduce Kaniko memory usage
      KANIKO_BUILD_OPTIONS="--snapshotMode=time --use-new-run"
      # If TARGET_NAME or TARGET is provided, add --target attribute to build
      [ -n "${TARGET_NAME:-$TARGET}" ] && KANIKO_BUILD_OPTIONS="${KANIKO_BUILD_OPTIONS} --target ${TARGET_NAME:-$TARGET}"
  rules: # Turn off component rules
    - if: $CI_COMMIT_BRANCH == "never"
      when: never

# Pre stage: cancel redundant branch pipeline when MR pipeline starts

cancel-branch-pipeline:
  stage: pre
  image: alpine:3.20
  interruptible: true
  timeout: 5m
  allow_failure: true
  tags:
    - qual-mcap-gcp
  variables:
    # Expect a project-level token with API scope. If not set, job will no-op.
    GITLAB_API_TOKEN: "${GITLAB_API_TOKEN}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_ID == $CI_MERGE_REQUEST_SOURCE_PROJECT_ID && $GITLAB_API_TOKEN
      when: on_success
    - when: never
  script:
    - |
      set -euo pipefail
      echo "Canceling redundant branch pipeline (if any) for ref=$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME sha=$CI_COMMIT_SHA…"
      apk add --no-cache curl jq >/dev/null
      SRC_PROJECT_ID="${CI_MERGE_REQUEST_SOURCE_PROJECT_ID:-$CI_PROJECT_ID}"
      BRANCH="$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
      REF_ENC="$(printf '%s' "$BRANCH" | jq -sRr @uri)"
      LIST_URL="$CI_API_V4_URL/projects/$SRC_PROJECT_ID/pipelines?ref=$REF_ENC&sha=$CI_COMMIT_SHA&per_page=100"
      if [ -z "${GITLAB_API_TOKEN:-}" ]; then
        echo "GITLAB_API_TOKEN not available; skipping cancel to avoid unauthorized API calls." && exit 0
      fi
      AUTH_HEADER="PRIVATE-TOKEN: $GITLAB_API_TOKEN"
      echo "Query: $LIST_URL (auth: PRIVATE-TOKEN)"
      STATUS="$(curl -sS -o resp.json -w '%{http_code}' -H "$AUTH_HEADER" "$LIST_URL" || echo 000)"
      case "$STATUS" in
        2*) : ;;
        *) echo "Pipelines list failed with HTTP $STATUS; body:"; cat resp.json || true; exit 0 ;;
      esac
      jq -r --arg sha "$CI_COMMIT_SHA" --arg cur "$CI_PIPELINE_ID" '
        if type=="array" then .[] else empty end
        | select(.sha == $sha)
        | select((.id|tostring) != $cur)
        | select(.status=="running" or .status=="pending")
        | .id
      ' resp.json | while read -r pid; do
        echo "Canceling pipeline $pid on branch $BRANCH (sha=$CI_COMMIT_SHA)…"
        curl -sS -X POST -H "$AUTH_HEADER" "$CI_API_V4_URL/projects/$SRC_PROJECT_ID/pipelines/$pid/cancel" >/dev/null || true
      done
      echo "Cancel step complete."

# Build images

build-rust-builder:
  extends: container-build
  stage: build
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
  timeout: 1h
  resource_group: "rust-builder-${IMAGE_TAG_CUSTOM}"
  tags:
    - qual-mcap-gcp
  variables:
    TARGET_NAME: "rust-builder"
    IMAGE_PATH_EXTRA: "rust-builder"
    KANIKO_CUSTOM_BUILD_ARGUMENTS: "WITH_WIN=0"
  # Consolidated rules: tags -> :$CI_COMMIT_TAG, default-branch changes -> :ci, branches/MRs -> per-commit <$CI_COMMIT_REF_SLUG>:$CI_COMMIT_SHA
  rules:
    # Release tags: publish builder as :$CI_COMMIT_TAG
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_TAG
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Merge requests: publish per-commit builder under <slug>:$CI_COMMIT_SHA
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_SHA
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Nightly/scheduled refresh of stable 'ci' tag on default branch
    - if: $CI_PIPELINE_SOURCE == "schedule"
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Default branch: rebuild stable 'ci' tag only when relevant build inputs change
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - Dockerfile
        - Cargo.toml
        - build.rs
        - .cargo/**/*
        - rust-toolchain.toml
        - src/**/*
        - toolchains/**/*
        - .gitlab-ci.yml
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Manual refresh of the 'ci' tag on default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Other branches: publish per-commit builder under <slug>:$CI_COMMIT_SHA
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_SHA
        IMAGE_TAG_CUSTOM_ONLY: "true"

build:
  extends: container-build
  stage: build
  interruptible: true
  timeout: 2h
  tags:
    - qual-mcap-gcp-mem4G
  retry:
    max: 2
    when:
      - script_failure
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
      - unknown_failure
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  rules: *rules_build_image
  parallel:
    matrix:
      - TARGET: [ "codex","crush","aider","openhands","opencode","plandex",
                  "codex-slim","crush-slim","aider-slim","openhands-slim","opencode-slim","plandex-slim" ]

build-toolchain:
  extends: container-build
  stage: build
  interruptible: true
  timeout: 1h 30m
  tags:
    - qual-mcap-gcp-mem4G
  retry:
    max: 2
    when:
      - script_failure
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
      - unknown_failure
  needs:
    - build-rust-builder  # Wait for first build to reuse layers
  variables:
    IMAGE_PATH_EXTRA: "$FOLDER"
    IMAGE_PREFIX: "coder-toolchain"
    DOCKER_FILE: "toolchains/$FOLDER/Dockerfile"
  rules:
    # Release tags: publish toolchain as :$CI_COMMIT_TAG
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_TAG
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Merge requests: publish per-commit toolchain under <slug>:$CI_COMMIT_SHA
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        IMAGE_TAG_CUSTOM: $CI_COMMIT_SHA
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Nightly/scheduled refresh of stable 'ci' tag on default branch
    - if: $CI_PIPELINE_SOURCE == "schedule"
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Default branch: rebuild stable 'ci' tag only when relevant build inputs change
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - Dockerfile
        - Cargo.toml
        - build.rs
        - .cargo/**/*
        - rust-toolchain.toml
        - src/**/*
        - toolchains/**/*
        - .gitlab-ci.yml
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
    # Manual refresh of the 'ci' tag on default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      variables:
        IMAGE_TAG_CUSTOM: "ci"
        IMAGE_TAG_CUSTOM_ONLY: "true"
  parallel:
    matrix:
      - FOLDER: [ "rust", "node", "cpp" ]


# Build executables

build-launcher:
  stage: build
  timeout: 45m
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
  needs:
    - job: build-rust-builder
  image: $CI_REGISTRY_IMAGE/aifo-coder-rust-builder:$CI_COMMIT_TAG
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  script:
    - cargo --version
    - rustc --version
    - echo "Building launcher (Linux native) ..."
    - cargo build --release
    - cp target/release/aifo-coder ./aifo-coder  # Copy to root folder to not have folder structure in GitLab artifacts
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  rules:
    - if: $CI_COMMIT_TAG


# Run tests

.rust-ci-base:
  stage: test
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
  timeout: 30m
  image: $RB_IMAGE
  # Use optional needs so default-branch 'ci' builder can be change-skipped while downstream jobs still run.
  needs:
    - job: build-rust-builder
      optional: true
  tags:
    - qual-mcap-gcp
  variables:
    RUST_BACKTRACE: "1"
    AIFO_SUPPORT_ANIMATE: "0"
    CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
    ARGS_NEXTEST: '--no-fail-fast --status-level=fail --hide-progress-bar --cargo-quiet --profile ci -E "!test(/^test_http_/) & !test(/^test_proxy_/)"'
    GIT_LFS_SKIP_SMUDGE: "1"
    AIFO_SUPPORT_SKIP_GREEN: "1"
  cache:
    key:
      files:
        - .cargo/config.toml
    policy: pull-push
    paths:
      - .cargo
      - target
  before_script:
    - echo "Running CI job (base)…"
    - rustc --version
    - cargo --version
    - cargo nextest --version || true
  rules: &rb_image_rules
    - if: $CI_COMMIT_TAG
      when: never
    # Merge requests: use per-commit builder image
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
        AIFO_CODER_TEST_CPP_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-toolchain-cpp:$CI_COMMIT_SHA"
        AIFO_CODER_TEST_RUST_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-toolchain-rust:$CI_COMMIT_SHA"
    # Non-default branches: use per-commit builder image
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
        AIFO_CODER_TEST_CPP_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-toolchain-cpp:$CI_COMMIT_SHA"
        AIFO_CODER_TEST_RUST_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-toolchain-rust:$CI_COMMIT_SHA"
    # Default branch: use stable 'ci' tag
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder:ci"
        AIFO_CODER_TEST_CPP_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-toolchain-cpp:ci"
        AIFO_CODER_TEST_RUST_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-toolchain-rust:ci"

lint:
  extends: .rust-ci-base
  script:
    - echo "Running lint job…"
    - make lint

test:
  extends: .rust-ci-base
  needs:
    - job: build-rust-builder
      optional: true
    - lint
  tags:
    - qual-mcap-gcp
  artifacts:
    when: always
    expire_in: 1 week
    reports:
      junit: target/nextest/ci/junit.xml
    paths:
      - target/nextest/ci/junit.xml
  script:
    - echo "Running test job…"
    - mkdir -p target/nextest/ci
    - make test
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_OPEN_MERGE_REQUESTS == null
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
      when: on_success

test-e2e:
  extends: .rust-ci-base
  stage: test
  interruptible: true
  timeout: 90m
  tags:
    - qual-mcap-gcp
  needs:
    - job: build-rust-builder
      optional: true
    - lint
  script:
    - echo "Running all tests (unit + acceptance + integration) in one nextest run…"
    - mkdir -p target/nextest/ci
    - make test-all-junit
  artifacts:
    when: always
    expire_in: 1 week
    reports:
      junit: target/nextest/ci/junit.xml
    paths:
      - target/nextest/ci/junit.xml
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
      when: on_success
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        RB_IMAGE: "$CI_REGISTRY_IMAGE/aifo-coder-rust-builder:ci"
      when: on_success

lint-dockerfiles:
  stage: test
  image: repository.migros.net/hadolint/hadolint:2.12.0-debian
  interruptible: true
  timeout: 10m
  tags:
    - qual-mcap-gcp
  script:
    - echo "Linting Dockerfiles with hadolint (advisory)..."
    - |
      FILES=""
      [ -f Dockerfile ] && FILES="$FILES Dockerfile"
      [ -f toolchains/rust/Dockerfile ] && FILES="$FILES toolchains/rust/Dockerfile"
      [ -f toolchains/node/Dockerfile ] && FILES="$FILES toolchains/node/Dockerfile"
      [ -f toolchains/cpp/Dockerfile ] && FILES="$FILES toolchains/cpp/Dockerfile"
      if [ -n "$FILES" ]; then
        hadolint --format gitlab_codeclimate $FILES > gl-code-quality-report.json || true
      else
        echo "No Dockerfiles found to lint."
      fi
  artifacts:
    when: always
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - gl-code-quality-report.json
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
    - if: $CI_COMMIT_BRANCH
      changes:
        - Dockerfile
        - toolchains/**/Dockerfile
        - .gitlab-ci.yml
  allow_failure: true

# Create release

publish-release:
  stage: release
  timeout: 45m
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - api_failure
      - stuck_or_timeout_failure
  dependencies:
    - build-launcher
  tags: # List of CI runners: https://wiki.migros.net/spaces/DEVOPS/pages/911828024/GitLab+CI+Runners#GitLabCIRunners-CIrunners
    - qual-mcap-gcp
  image: repository.migros.net/registry.gitlab.com/gitlab-org/release-cli:v0.24.0
  script:
    - echo "Running the release job."
  artifacts:
    expire_in: 1 week
    paths:
      - aifo-coder
      - README.md
      - NOTICE
      - LICENSE
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "$CI_COMMIT_MESSAGE"
    assets:
      links:
        - name: aifo-coder
          url: $CI_JOB_URL/artifacts/download
  rules:
    - if: $CI_COMMIT_TAG
